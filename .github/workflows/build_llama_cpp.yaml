name: Build llama.cpp linux binaries

on:
  push:

env:
  BRANCH_NAME: ${{ github.head_ref || github.ref_name }}
  GGML_NLOOP: 3
  GGML_N_THREADS: 1

jobs:
  ubuntu-latest-build:
    runs-on: ubuntu-latest

    env:
      OPENCL_VERSION: 2023.04.17
      CLBLAST_VERSION: 1.6.0
      SDE_VERSION: 9.33.0-2024-01-07

    strategy:
      matrix:
        include:
          - build: 'noavx'
            defines: '-DLLAMA_NATIVE=OFF -DLLAMA_BUILD_SERVER=ON -DLLAMA_AVX=OFF -DLLAMA_AVX2=OFF -DLLAMA_FMA=OFF -DBUILD_SHARED_LIBS=ON'
          # - build: 'avx2'
          #   defines: '-DLLAMA_NATIVE=OFF -DLLAMA_BUILD_SERVER=ON -DBUILD_SHARED_LIBS=ON'
          # - build: 'avx'
          #   defines: '-DLLAMA_NATIVE=OFF -DLLAMA_BUILD_SERVER=ON -DLLAMA_AVX2=OFF -DBUILD_SHARED_LIBS=ON'
          # - build: 'avx512'
          #   defines: '-DLLAMA_NATIVE=OFF -DLLAMA_BUILD_SERVER=ON -DLLAMA_AVX512=ON -DBUILD_SHARED_LIBS=ON'
          # - build: 'clblast'
          #   defines: '-DLLAMA_NATIVE=OFF -DLLAMA_BUILD_SERVER=ON -DLLAMA_CLBLAST=ON -DBUILD_SHARED_LIBS=ON -DCMAKE_PREFIX_PATH="$env:RUNNER_TEMP/clblast"'
          # - build: 'arm64'
          #   defines: '-A ARM64 -DLLAMA_NATIVE=OFF -DLLAMA_BUILD_SERVER=ON -DBUILD_SHARED_LIBS=ON'


    steps:
      - name: Clone
        id: checkout
        uses: actions/checkout@v3
      
      - name: Determine tag name
        id: tag
        shell: bash
        run: |
          LLAMACPP_VERSION="$(cat Runtime/LLMUnitySetup.cs |grep LLamaCPPVersion|cut -d '"' -f2)"
          echo "name=${SAFE_NAME}-b${BUILD_NUMBER}-${SHORT_HASH}" >> $GITHUB_OUTPUT

      - name: Clone llama.cpp
        run: |
        git clone https://github.com/ggerganov/llama.cpp llama.cpp
        cd llama.cpp
        git checkout ${{ steps.tag.outputs.name }}

     - name: Dependencies
       run: |
         sudo apt-get update
         sudo apt-get install build-essential
         sudo apt-get install cmake
         sudo apt-get install tar
         sudo apt-get install p7zip-full

      - name: Download OpenCL SDK
        id: get_opencl
        if: ${{ matrix.build == 'clblast' }}
        run: |
          curl -o $env:RUNNER_TEMP/opencl.zip -L "https://github.com/KhronosGroup/OpenCL-SDK/releases/download/v${env:OPENCL_VERSION}/OpenCL-SDK-v${env:OPENCL_VERSION}-Win-x64.zip"
          mkdir $env:RUNNER_TEMP/opencl
          unzip -q "$RUNNER_TEMP/opencl.zip" -d "$RUNNER_TEMP/opencl"
          unzip -q "$RUNNER_TEMP/opencl.zip" -d "$RUNNER_TEMP"
          mv "$RUNNER_TEMP"/opencl/*/* "$RUNNER_TEMP"/opencl/

      - name: Download CLBlast
        id: get_clblast
        if: ${{ matrix.build == 'clblast' }}
        run: |
          curl -o $env:RUNNER_TEMP/clblast.7z -L "https://github.com/CNugteren/CLBlast/releases/download/${env:CLBLAST_VERSION}/CLBlast-${env:CLBLAST_VERSION}-windows-x64.7z"
          curl -o $env:RUNNER_TEMP/CLBlast.LICENSE.txt -L "https://github.com/CNugteren/CLBlast/raw/${env:CLBLAST_VERSION}/LICENSE"
          7z x "-o${env:RUNNER_TEMP}" $env:RUNNER_TEMP/clblast.7z
          mv $env:RUNNER_TEMP/CLBlast-${env:CLBLAST_VERSION}-windows-x64 clblast
          find "$RUNNER_TEMP/clblast" -type f -name '*.cmake' -print0 | while IFS= read -r -d '' f; do
              txt=$(<"$f")
              echo "$txt" | sed "s|C:/vcpkg/packages/opencl_x64-windows/|$RUNNER_TEMP/opencl/|g" > "$f"
          done

      - name: Build
        id: cmake_build
        run: |
          mkdir build
          cd build
          cmake ../llama.cpp ${{ matrix.defines }}
          cmake --build . --config Release -j ${env:NUMBER_OF_PROCESSORS}

      - name: Add clblast.dll
        id: add_clblast_dll
        if: ${{ matrix.build == 'clblast' }}
        run: |
          cp $env:RUNNER_TEMP/clblast/lib/clblast.dll ./build/bin/Release
          cp $env:RUNNER_TEMP/CLBlast.LICENSE.txt ./build/bin/Release/CLBlast-${env:CLBLAST_VERSION}.txt

      - name: Test
        id: cmake_test
        run: |
          cd build
          ctest -L main -C Release --verbose --timeout 900

      - name: Pack artifacts
        id: pack_artifacts
        run: |
          cp llama.cpp/LICENSE .\build\bin\llama.cpp.txt
          7z a llama-${{ steps.tag.outputs.name }}-bin-linux-${{ matrix.build }}-x64.zip .\build\bin\Release\*

      - name: Upload artifacts
        if: ${{ ( github.event_name == 'push' && github.ref == 'refs/heads/master' ) || github.event.inputs.create_release == 'true' }}
        uses: actions/upload-artifact@v3
        with:
          path: |
            llama-${{ steps.tag.outputs.name }}-bin-linux-${{ matrix.build }}-x64.zip
